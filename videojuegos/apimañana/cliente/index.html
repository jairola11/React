<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumir API Rest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

</head>
<body>
    <div class="container">
        <div class="rows">
            <button class="btn btn-primary" onclick="nuevoUsuario()">Nuevo Usuario</button>
        </div>
        <div class="rows">
            <table class="table table-striped">
                <th>ID</th>
                <th>Nombre</th>
                <th>Dirección</th>
                <th>Teléfono</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Administrar</th>
                <th>Actualizar</th>
                <tbody id="tabla-usuario"></tbody>
            </table>
        </div>
    </div>

        <!-- Modal -->
    <div class="modal fade modal-lg" id="ModalUsuario" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Administrar usuarios</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="">
                    <div class="rows">
                        <div class="cols-4">
                            <label for="identificacion">Identificación: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="identificacion" class="form-control" placeholder="Ingrese Identificacion...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="nombres">Nombres: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="nombres" class="form-control" placeholder="Ingrese nombres...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="direccion">Dirección: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="direccion" class="form-control" placeholder="Ingrese direccion...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="telefono">Telefono: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="telefono" class="form-control" placeholder="Ingrese teléfono...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="correo">Correo: </label> </div>
                        <div class="cols-8">
                            <input type="email" id="correo" class="form-control" placeholder="Ingrese email...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="rol">Rol: </label> </div>
                        <div class="cols-8">
                            <select class="form-control" id="rol">
                                <option value="">Seleccione una opción</option>
                                <option value="administrador">Administrador</option>
                                <option value="usuario">Usuario</option>
                            </select>
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="password">Contraseña: </label> </div>
                        <div class="cols-8">
                            <input type="password" id="password" class="form-control" placeholder="Ingresecontraseña...">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="registrarUsuario()">Registrar Usuario</button>
            </div>
        </div>
        </div>
    </div>

    <div class="modal fade modal-lg" id="ModalUsuarioActualizar" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Actualizar usuario</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form name="actuaUser" action="">
                    <input type="number" id="idusuario" value="">
                    <div class="rows">
                        <div class="cols-4">
                            <label for="nombres">Nombres: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="nombres2" name="nombres" placeholder="Ingrese el nombre" class="form-control">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="direccion">Dirección: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="direccion2" class="form-control" placeholder="Ingrese direccion...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="telefono">Telefono: </label> </div>
                        <div class="cols-8">
                            <input type="text" id="telefono2" class="form-control" placeholder="Ingrese teléfono...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="correo">Correo: </label> </div>
                        <div class="cols-8">
                            <input type="email" id="correo2" class="form-control" placeholder="Ingrese email...">
                        </div>
                    </div>
                    <div class="rows">
                        <div class="cols-4">
                            <label for="rol">Rol: </label> </div>
                        <div class="cols-8">
                            <select class="form-control" id="rol2">
                                <option value="">Seleccione una opción</option>
                                <option value="administrador">Administrador</option>
                                <option value="usuario">Usuario</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-primary" onclick="actualizarUsuario()">Actualizar Usuario</button>
            </div>
        </div>
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script>
        var ModalUsuario = new bootstrap.Modal(document.getElementById('ModalUsuario'), {
        keyboard: false
        })

        var ModalUsuarioActualizar = new bootstrap.Modal(document.getElementById('ModalUsuarioActualizar'), {
        keyboard: false
        })
    
    listarUsuarios ()

    function registrarUsuario() {
        let datos = new URLSearchParams();
        datos.append('idusuario',document.getElementById('identificacion').value);
        datos.append('nombres',document.getElementById('nombres').value);
        datos.append('direccion',document.getElementById('direccion').value);
        datos.append('telefono',document.getElementById('telefono').value);
        datos.append('correo',document.getElementById('correo').value);
        datos.append('rol',document.getElementById('rol').value);
        datos.append('password',document.getElementById('password').value);
        fetch ("http://localhost:4000/usuario/registrar",
            {
                method: 'POST',
                body:datos
            }
        )
        .then(resp=> resp.json())
        .then(data=>{
            listarUsuarios();
            ModalUsuario.hide();
            Swal.fire({
                title: "Usuario registrado",
                text: data.message,
                icon:"success",
                ConfirmButtonText:"Cerrar"
            })
        })
    }

    function listarUsuarios () {
        fetch('http://localhost:4000/usuario/listarusuario',
        {
            method:'get'
        })
        .then(resp=>resp.json())
        .then(data=>{
            let filas ='';
            data.forEach(element => {
                // filas = filas+ es igual a filas +=
                filas +=  `<tr>
                                <td>${element.idusuario}</td>
                                <td>${element.nombres}</td>
                                <td>${element.direccion}</td>
                                <td>${element.telefono}</td>
                                <td>${element.correo}</td>
                                <td>${element.rol}</td>             
                                <td><a href="javaScript:eliminarUsuario(${element.idusuario});">Eliminar</a></td>        
                                <td><a href="javaScript:mostrarActualizarUser(${element.idusuario});">Actualizar</a></td>          
                                </tr>`
            });
            document.getElementById('tabla-usuario').innerHTML=filas;
        }).catch(err=>console.log(err))
    }
    function mostrarActualizarUser(id){
        //limpiarFormulario();
        //ModalUsuarioActualizar.show(id);
        //console.log(id)

        limpiarFormulario();
        ModalUsuarioActualizar.show(id);
        buscarUsuario(id)
        document.getElementById('idusuario').value=id;
    }
    function nuevoUsuario() {
        limpiarFormulario();
        ModalUsuario.show();
    }

    function eliminarUsuario(id) {
        fetch(`http://localhost:4000/usuario/eliminar/${id}`,
        {
            method:'delete',
        })
        .then(resp=>{
            
            if(resp.status==200){return resp.json()}
            if(resp.status==500){
                Swal.fire({
                title: "Mensaje",
                text: data.message,
                icon:"success",
                ConfirmButtonText:"Cerrar"
            })
            }
            resp.json()
        })
        .then( data=> {
            listarUsuarios();

            Swal.fire({
                title: "Se eliminó el usuario con éxito",
                text: data.message,
                icon:"success",
                ConfirmButtonText:"Cerrar"
            })
        })
    }

    function actualizarUsuario() {
        let datos = new URLSearchParams();
        let idhoy= document.getElementById('idusuario').value;
        datos.append('nombres',document.getElementById('nombres2').value);
        datos.append('direccion',document.getElementById('direccion2').value);
        datos.append('telefono',document.getElementById('telefono2').value);
        datos.append('correo',document.getElementById('correo2').value);
        datos.append('rol',document.getElementById('rol2').value);
        
        fetch (`http://localhost:4000/usuario/actualizar/${idhoy}`,
            {
                method: 'PUT',
                body:datos
            }
        )
        .then(resp=> resp.json())
        .then(data=>{
            listarUsuarios();
            ModalUsuarioActualizar.hide();
            Swal.fire({
                title: "Usuario Actualizado",
                text: data.message,
                icon:"success",
                ConfirmButtonText:"Cerrar"
            })
        })
    }
    function limpiarFormulario(){
        document.getElementById('identificacion').value="";
        document.getElementById('nombres').value="";
        document.getElementById('direccion').value="";
        document.getElementById('telefono').value="";
        document.getElementById('correo').value="";
        document.getElementById('rol').value="";
    }

    function seleccionarUsuario(id){
        limpiarFormulario();
        ModalUsuario.show();
        buscarUsuario(id)
    }

    function buscarUsuario(id){
        fetch(`http://localhost:4000/usuario/buscarusuario/${id}`,
        {
            method:'GET'
        })
        .then(resp => resp.json())
        .then(data=>{
            console.log(data)
            document.getElementById('nombres2').value=data[0].nombres;
            document.getElementById('direccion2').value=data[0].direccion;
            document.getElementById('telefono2').value=data[0].telefono;
            document.getElementById('correo2').value=data[0].correo;
            document.getElementById('rol2').value=data[0].rol;
        }).catch(err=>{console.log(err);})
    }
</script>
</html>